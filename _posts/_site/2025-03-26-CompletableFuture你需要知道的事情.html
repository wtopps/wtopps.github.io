<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/CompletableFuture.jpeg?raw=true" alt="banner" /></p>

<h1 id="问题">问题</h1>

<p>面试官：请使用多线程分别打印“Hello World”，当全部线程执行完成后，打印“Finish”。</p>

<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/please%20show%20yourself.jpeg?raw=true" alt="please show yourself" /></p>

<p>这是一道非常经典的面试题，Java的面试中高频出现，主要考察多线程的使用和join()的应用，我们来尝试实现一下：</p>

<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/%E9%9C%B2%E4%B8%80%E6%89%8B.jpg?raw=true" alt="露一手" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadJoinDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">threadA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyThread</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">threadB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyThread</span><span class="o">();</span>
        <span class="n">threadA</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"threadA"</span><span class="o">);</span>
        <span class="n">threadB</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"threadB"</span><span class="o">);</span>
        <span class="n">threadA</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">threadB</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">threadA</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">threadB</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">MyThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>输出结果：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hello World
Hello World
Finish
</code></pre></div></div>

<p>面试官：小伙子不错，你还有没有更优雅的实现方式？</p>

<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/%E8%BF%99%E4%B8%AA%E5%8F%AF%E4%BB%A5%E6%9C%89.png?raw=true" alt="这个可以有" /></p>

<h1 id="completablefuture">CompletableFuture</h1>

<h2 id="一概述">一、概述</h2>

<p>CompletableFuture 是 Java 8 引入的一个强大的异步编程工具，它实现了 Future 和 CompletionStage 接口，提供了丰富的异步操作和组合能力。相比传统的 Future，CompletableFuture 具有以下优势：</p>

<ol>
  <li>支持显式完成（手动设置结果）</li>
  <li>提供丰富的回调机制</li>
  <li>支持链式调用和组合操作</li>
  <li>内置异常处理机制</li>
  <li>支持多个 CompletableFuture 的组合</li>
</ol>

<p>回到上面的问题，如果使用CompletableFuture如何实现？</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
    <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">)),</span>
    <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello World"</span><span class="o">))</span>
<span class="o">);</span>
<span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">])).</span><span class="na">join</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Finish"</span><span class="o">));</span>
</code></pre></div></div>

<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/%E4%BC%98%E9%9B%85.gif?raw=true" alt="优雅" /></p>

<p>下面我们来一起了解一下CompletableFuture的细节。</p>

<h2 id="二核心实现细节">二、核心实现细节</h2>

<h3 id="1-基本结构">1. 基本结构</h3>

<p>CompletableFuture 的核心字段包括：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>volatile Object result;       // 结果或异常的包装
volatile Completion stack;    // 依赖此 Future 的操作栈
</code></pre></div></div>

<h3 id="2-完成机制">2. 完成机制</h3>

<p>CompletableFuture 可以通过以下方式完成：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">complete(T value)</code>：正常完成</li>
  <li><code class="language-plaintext highlighter-rouge">completeExceptionally(Throwable ex)</code>：异常完成</li>
  <li><code class="language-plaintext highlighter-rouge">cancel(boolean mayInterruptIfRunning)</code>：取消任务</li>
</ul>

<h3 id="3-依赖关系管理">3. 依赖关系管理</h3>

<p>CompletableFuture 使用 <code class="language-plaintext highlighter-rouge">Completion</code> 链表来管理依赖关系。当一个 CompletableFuture 完成时，它会触发所有依赖它的操作。</p>

<h3 id="4-线程池使用">4. 线程池使用</h3>

<p>默认情况下，CompletableFuture 使用 <code class="language-plaintext highlighter-rouge">ForkJoinPool.commonPool()</code> 作为异步执行的线程池。可以通过提供自定义的 <code class="language-plaintext highlighter-rouge">Executor</code> 来改变这一行为。</p>

<h2 id="三核心-api-和使用技巧">三、核心 API 和使用技巧</h2>

<h3 id="1-创建-completablefuture">1. 创建 CompletableFuture</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. 使用静态工厂方法创建已完成的 Future</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">completedFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">completedFuture</span><span class="o">(</span><span class="s">"Hello"</span><span class="o">);</span>

<span class="c1">// 2. 创建异步任务</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">runAsyncFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// 无返回值的异步任务</span>
<span class="o">});</span>

<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">supplyAsyncFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="c1">// 有返回值的异步任务</span>
    <span class="k">return</span> <span class="s">"Result"</span><span class="o">;</span>
<span class="o">});</span>

<span class="c1">// 3. 使用自定义线程池</span>
<span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">customExecutorFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"Result with custom executor"</span><span class="o">;</span>
<span class="o">},</span> <span class="n">executor</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="2-结果处理和转换">2. 结果处理和转换</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// thenApply - 同步转换结果</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"Hello"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" World"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="nl">String:</span><span class="o">:</span><span class="n">toUpperCase</span><span class="o">);</span>

<span class="c1">// thenApplyAsync - 异步转换结果</span>
<span class="n">future</span><span class="o">.</span><span class="na">thenApplyAsync</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">"!"</span><span class="o">);</span>

<span class="c1">// thenAccept - 消费结果但不返回新值</span>
<span class="n">future</span><span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

<span class="c1">// thenRun - 不消费结果，只执行操作</span>
<span class="n">future</span><span class="o">.</span><span class="na">thenRun</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Operation completed"</span><span class="o">));</span>
</code></pre></div></div>

<h3 id="3-组合多个-future">3. 组合多个 Future</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// thenCompose - 扁平化 Future</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future1</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"Hello"</span><span class="o">);</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future2</span> <span class="o">=</span> <span class="n">future1</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> 
    <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" World"</span><span class="o">));</span>

<span class="c1">// thenCombine - 合并两个独立 Future 的结果</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future3</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"Hello"</span><span class="o">);</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future4</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">"World"</span><span class="o">);</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">combined</span> <span class="o">=</span> <span class="n">future3</span><span class="o">.</span><span class="na">thenCombine</span><span class="o">(</span><span class="n">future4</span><span class="o">,</span> <span class="o">(</span><span class="n">s1</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">s1</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">s2</span><span class="o">);</span>

<span class="c1">// allOf - 等待所有 Future 完成</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">all</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">future1</span><span class="o">,</span> <span class="n">future2</span><span class="o">,</span> <span class="n">future3</span><span class="o">);</span>

<span class="c1">// anyOf - 等待任意一个 Future 完成</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">any</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">anyOf</span><span class="o">(</span><span class="n">future1</span><span class="o">,</span> <span class="n">future2</span><span class="o">,</span> <span class="n">future3</span><span class="o">);</span>
</code></pre></div></div>

<p>关于allOf()方法，有一点需要注意，allOf()方法的注释是这样描述的：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Returns a new CompletableFuture that is completed when all of the given CompletableFutures complete. If any of the given CompletableFutures complete exceptionally, then the returned CompletableFuture also does so, with a CompletionException holding this exception as its cause. Otherwise, the results, if any, of the given CompletableFutures are not reflected in the returned CompletableFuture, but may be obtained by inspecting them individually. If no CompletableFutures are provided, returns a CompletableFuture completed with the value null.
</code></pre></div></div>

<p>看完第一句话，可能会理解为，哦这个方法是等待所有的Future完成后，才返回结果呀，其实非也。</p>

<p>这句注释需要仔细理解：</p>

<p><strong>“Returns a new CompletableFuture that is completed when all of the given CompletableFutures complete”</strong></p>

<p>关键在于：</p>

<ol>
  <li>“Returns a new CompletableFuture” - 立即返回一个新的Future对象</li>
  <li>“is completed when…” - 这个新Future在所有子Future完成时才会完成</li>
</ol>

<p>可以做一个实验进行验证：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建几个任务</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future1</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"Task 1"</span><span class="o">;</span>
<span class="o">});</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future2</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="n">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="k">return</span> <span class="s">"Task 2"</span><span class="o">;</span>
<span class="o">});</span>

<span class="c1">// allOf返回的新Future</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">allFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">future1</span><span class="o">,</span> <span class="n">future2</span><span class="o">);</span>
<span class="c1">// 这行代码立即返回，不会等待</span>

<span class="c1">// 新Future的状态</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is completed: "</span> <span class="o">+</span> <span class="n">allFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>  <span class="c1">// false</span>
<span class="c1">// 等待2秒后</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Is completed: "</span> <span class="o">+</span> <span class="n">allFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">());</span>  <span class="c1">// true</span>
</code></pre></div></div>

<p>如果你希望全部的Future执行完成之前，主线程进行阻塞等待结果，你需要这样：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">all</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">future1</span><span class="o">,</span> <span class="n">future2</span><span class="o">,</span> <span class="n">future3</span><span class="o">);</span>
<span class="n">all</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</code></pre></div></div>

<h3 id="4-异常处理">4. 异常处理</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Error"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">"Success"</span><span class="o">;</span>
<span class="o">})</span>
<span class="o">.</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Exception: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="k">return</span> <span class="s">"Recovered"</span><span class="o">;</span>
<span class="o">})</span>
<span class="o">.</span><span class="na">handle</span><span class="o">((</span><span class="n">result</span><span class="o">,</span> <span class="n">ex</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Handled error: "</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">"Handled result: "</span> <span class="o">+</span> <span class="n">result</span><span class="o">;</span>
<span class="o">});</span>
</code></pre></div></div>

<h3 id="5-完成控制">5. 完成控制</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">&lt;&gt;();</span>

<span class="c1">// 手动完成</span>
<span class="n">future</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="s">"Manual completion"</span><span class="o">);</span>

<span class="c1">// 手动异常完成</span>
<span class="n">future</span><span class="o">.</span><span class="na">completeExceptionally</span><span class="o">(</span><span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">"Failed"</span><span class="o">));</span>

<span class="c1">// 超时完成</span>
<span class="n">future</span><span class="o">.</span><span class="na">completeOnTimeout</span><span class="o">(</span><span class="s">"Default"</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>

<span class="c1">// 或超时</span>
<span class="n">future</span><span class="o">.</span><span class="na">orTimeout</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="四高级使用技巧">四、高级使用技巧</h2>

<h3 id="1-流水线模式">1. 流水线模式</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">fetchData</span><span class="o">())</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">data</span> <span class="o">-&gt;</span> <span class="n">processData</span><span class="o">(</span><span class="n">data</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">processedData</span> <span class="o">-&gt;</span> <span class="n">storeData</span><span class="o">(</span><span class="n">processedData</span><span class="o">))</span>
    <span class="o">.</span><span class="na">thenAccept</span><span class="o">(</span><span class="n">storedId</span> <span class="o">-&gt;</span> <span class="n">logSuccess</span><span class="o">(</span><span class="n">storedId</span><span class="o">))</span>
    <span class="o">.</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="n">logError</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">});</span>
</code></pre></div></div>

<h3 id="2-异步超时控制">2. 异步超时控制</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">withTimeout</span><span class="o">(</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">future</span><span class="o">,</span> 
        <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span> <span class="no">T</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="na">applyToEither</span><span class="o">(</span>
        <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">defaultValue</span><span class="o">)</span>
            <span class="o">.</span><span class="na">completeOnTimeout</span><span class="o">(</span><span class="n">defaultValue</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">unit</span><span class="o">),</span>
        <span class="nc">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">()</span>
    <span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="3-批量操作">3. 批量操作</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">url</span> <span class="o">-&gt;</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">fetchUrl</span><span class="o">(</span><span class="n">url</span><span class="o">)))</span>
    <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">allDone</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>

<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">allResults</span> <span class="o">=</span> <span class="n">allDone</span><span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">v</span> <span class="o">-&gt;</span> 
    <span class="n">futures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CompletableFuture:</span><span class="o">:</span><span class="n">join</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
</code></pre></div></div>

<h3 id="4-取消传播">4. 取消传播</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future1</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">"Result"</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">});</span>

<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future2</span> <span class="o">=</span> <span class="n">future1</span><span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="o">+</span> <span class="s">" processed"</span><span class="o">);</span>

<span class="c1">// 取消第一个 future 会导致依赖它的 future 也被取消</span>
<span class="n">future1</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="五性能优化和注意事项">五、性能优化和注意事项</h2>

<ol>
  <li><strong>线程池选择</strong>：根据任务类型选择合适的线程池
    <ul>
      <li>CPU密集型：使用有界线程池（如 <code class="language-plaintext highlighter-rouge">Executors.newFixedThreadPool</code>）</li>
      <li>IO密集型：使用无界线程池（如 <code class="language-plaintext highlighter-rouge">Executors.newCachedThreadPool</code>）</li>
    </ul>
  </li>
  <li><strong>避免阻塞</strong>：不要在回调中进行阻塞操作</li>
  <li><strong>合理使用异步</strong>：并非所有操作都需要异步，简单的转换可以直接用同步方法</li>
  <li><strong>资源清理</strong>：长时间运行的 CompletableFuture 链可能会持有资源，需要适当清理</li>
  <li><strong>异常处理</strong>：确保所有可能的异常路径都被处理</li>
  <li><strong>避免嵌套过深</strong>：过深的 CompletableFuture 链会影响可读性</li>
</ol>

<h2 id="六常见问题解决方案">六、常见问题解决方案</h2>

<h3 id="1-如何获取多个-future-的结果">1. 如何获取多个 Future 的结果？</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="o">...;</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">allFutures</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span>
    <span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>

<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">allResults</span> <span class="o">=</span> <span class="n">allFutures</span><span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="n">v</span> <span class="o">-&gt;</span>
    <span class="n">futures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CompletableFuture:</span><span class="o">:</span><span class="n">join</span><span class="o">)</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>


<span class="c1">// 使用CompletableFuture并行处理图片上传</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">JSONObject</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">imageInfo</span> <span class="o">-&gt;</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nf">uploadCorePic</span><span class="o">();</span>
        <span class="o">}))</span>
        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>

<span class="c1">// 等待所有图片上传完成</span>
<span class="nc">JSONArray</span> <span class="n">picArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSONArray</span><span class="o">();</span>
<span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="nc">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">])).</span><span class="na">join</span><span class="o">();</span>
<span class="n">futures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CompletableFuture:</span><span class="o">:</span><span class="n">join</span><span class="o">)</span>
        <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">Objects:</span><span class="o">:</span><span class="n">nonNull</span><span class="o">)</span>
        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">picArray:</span><span class="o">:</span><span class="n">add</span><span class="o">);</span>
</code></pre></div></div>

<h3 id="2-如何实现重试机制">2. 如何实现重试机制？</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">retry</span><span class="o">(</span><span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;&gt;</span> <span class="n">task</span><span class="o">,</span> 
        <span class="kt">int</span> <span class="n">maxRetries</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delay</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">maxRetries</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">ex</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">unit</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">delay</span><span class="o">));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">join</span><span class="o">();</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">future</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="3-如何实现优雅的超时回退">3. 如何实现优雅的超时回退？</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">withFallback</span><span class="o">(</span>
        <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">future</span><span class="o">,</span> <span class="c1">// 原始任务</span>
        <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span> <span class="c1">// 超时时间及其时间单位</span>
        <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">fallback</span><span class="o">)</span> <span class="o">{</span>			 <span class="c1">// 降级逻辑</span>
    <span class="kd">final</span> <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">timeoutFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">unit</span><span class="o">.</span><span class="na">toMillis</span><span class="o">(</span><span class="n">timeout</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">fallback</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">fallback</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">});</span>
    <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="na">applyToEither</span><span class="o">(</span><span class="n">timeoutFuture</span><span class="o">,</span> <span class="nc">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<p>使用示例：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 创建一个可能耗时的任务</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>  <span class="c1">// 模拟耗时操作</span>
        <span class="k">return</span> <span class="s">"任务正常完成"</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"被中断"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">});</span>

<span class="c1">// 使用withFallback添加3秒超时</span>
<span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">withTimeout</span> <span class="o">=</span> <span class="n">withFallback</span><span class="o">(</span>
    <span class="n">future</span><span class="o">,</span>
    <span class="mi">3</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
    <span class="o">()</span> <span class="o">-&gt;</span> <span class="s">"任务超时，返回降级结果"</span>
<span class="o">);</span>

<span class="c1">// 获取结果</span>
<span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">withTimeout</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>  <span class="c1">// 会打印"任务超时，返回降级结果"</span>

</code></pre></div></div>

<p>执行示意图：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>原始任务 future     ----5秒-----&gt; "任务正常完成"
                            \
                             \-- 采用先完成的结果
                            /
超时任务 timeoutFuture ----3秒-----&gt; "降级结果"
</code></pre></div></div>

<h2 id="七总结">七、总结</h2>

<p>CompletableFuture 是 Java 异步编程的强大工具，通过合理使用可以构建高效、清晰的异步代码。掌握其核心概念、API 和最佳实践，可以帮助开发者编写更健壮、更易维护的并发应用程序。在实际使用中，应根据具体场景选择合适的组合方式，并注意资源管理和异常处理。</p>
