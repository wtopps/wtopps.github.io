<p><img src="https://github.com/wtopps/wtopps.github.io/blob/master/images/Redis%20Lock.jpeg?raw=true" alt="banner" /></p>

<h2 id="背景">背景</h2>

<p>分布式锁在业务场景中的应用十分广泛，当你的服务部署在分布式的多节点集群中，在执行某一个方法时，需要控制并发的情况，保证同一时间只有一个请求可以执行，你一定需要分布式锁来实现。</p>

<p>最常见的分布式锁，一般就是Redis和ZK（亦或者MySQL的for update也可以充当），当然也有很多其他的实现，本篇的主角，就是Redis，我们来逐步使用实现一个简单易用的Redis分布式锁。</p>

<h2 id="redislock">RedisLock</h2>

<p>首先，我们先来回忆一下Java的Lock是怎么玩的：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="c1">// do something...</span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>很简单，很优雅，那么我们就仿照Java的API来实现我们的Redis Lock。</p>

<p>最直观的实现方式，就是使用Redis String的setnx方法，如果key存在就放弃，如果key不存在就set一个值，并指定过期时间，释放锁时，就把key删除，非常easy。</p>

<p>Version1：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>
  	<span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
        <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">res</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="s">"nx"</span><span class="o">,</span> <span class="s">"px"</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"OK"</span><span class="o">,</span> <span class="n">res</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
        <span class="nc">Long</span> <span class="n">res</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">res</span><span class="o">,</span> <span class="mi">1L</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>  
</code></pre></div></div>

<p>Version1的实现非常简单，也可以满足基本的需求，但是有一个问题，任何线程，只要知道lockkey的名称，都可以调用unlock方法，这显然不是我们所希望的，所以我们在此基础上，进行一点优化，只有加锁的人，才可以释放锁，因此，我们需要保存一些额外的信息。</p>

<p>Version2:</p>

<p>我们新建一个Bean，存储RedisLock的相关信息，改造后我们的实现如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLock</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">,</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startLockTimeMillis</span> <span class="o">=</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getLockTimeMillis</span> <span class="o">=</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="no">UUID</span> <span class="nf">getUuid</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getLockTimeout</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLockTimeout</span><span class="o">(</span><span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getGetLockTimeMillis</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGetLockTimeMillis</span><span class="o">(</span><span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getLockTimeMillis</span> <span class="o">=</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStartLockTimeMillis</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStartLockTimeMillis</span><span class="o">(</span><span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startLockTimeMillis</span> <span class="o">=</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="c1">// 释放锁的Lua脚本</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_UNLOCK</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('del', KEYS[1]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
        <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">res</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="s">"nx"</span><span class="o">,</span> <span class="s">"px"</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"OK"</span><span class="o">,</span> <span class="n">res</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_UNLOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">)</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Well，改造后的方法，好像比Version1复杂了一些，别着急，其实并不复杂，为了保证原子性，删除lockkey部分我们采用了Lua脚本的方式实现，只有当lockkey的value校验一致时，才可以对key进行删除，这样就解决了Version1中出现的问题。</p>

<p>Version2基本可以运行的很好了，但是还有一个问题，我们知道Java的synchronized和ReentrantLock的实现，都是带有自旋抢锁功能的，当第一次没有获取到锁后，会尝试自旋等待，再次尝试抢锁，而我们的实现，好像并不具备这个功能，这怎么可以呢？那我们也要加入自旋。</p>

<p>Version3：</p>

<p>在RedisLock Bean中加入一些额外的信息：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLock</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">tryCount</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">,</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">,</span> <span class="kt">int</span> <span class="n">tryCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startLockTimeMillis</span> <span class="o">=</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getLockTimeMillis</span> <span class="o">=</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tryCount</span> <span class="o">=</span> <span class="n">tryCount</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getKey</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">key</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setKey</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="no">UUID</span> <span class="nf">getUuid</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getLockTimeout</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLockTimeout</span><span class="o">(</span><span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getGetLockTimeMillis</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setGetLockTimeMillis</span><span class="o">(</span><span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getLockTimeMillis</span> <span class="o">=</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getStartLockTimeMillis</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStartLockTimeMillis</span><span class="o">(</span><span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startLockTimeMillis</span> <span class="o">=</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getTryCount</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">tryCount</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTryCount</span><span class="o">(</span><span class="kt">int</span> <span class="n">tryCount</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tryCount</span> <span class="o">=</span> <span class="n">tryCount</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>  
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="c1">//拿锁的EVAL函数</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_LOCK</span> <span class="o">=</span> <span class="s">"return redis.call('SET', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) "</span><span class="o">;</span>

    <span class="c1">// 释放锁的Lua脚本</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_UNLOCK</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('del', KEYS[1]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
            <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">tryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">tryLockTimeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
                <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_LOCK</span><span class="o">,</span>
                        <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">key</span><span class="o">),</span>
                        <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">))</span>
                <span class="o">);</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
                <span class="n">tryCount</span><span class="o">++;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="n">tryCount</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Fail to get lock key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_UNLOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">)</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          	<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Fail to unlock key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Well，Version3版本可以算是一个里程碑的版本，我们在获取锁的方法中，加入了自旋抢锁的功能，可以指定抢锁的超时时间，在此之前，当前线程会一直自旋尝试获取锁，在这个版本中，我们将加锁的方式，也换成了LUA脚本，由于老旧版本的Redis还不支持setnx指定过期时间，为了兼容性考虑，我们这里采用LUA的方式。</p>

<p>Version3已经是一个非常可用的版本了，但是如果我们有更高的要求，还是有一点问题的，就是线程安全问题，假如线程A获取锁成功，并拿到了RedisLock对象，而线程B拿着该对象，调用解锁的方法，是可以解锁成功的，虽然这是一种极端场景，但是也确实有可能发生，为了避免这个问题，我们需要考虑线程一致性的问题，即加锁和解锁的线程，必须是同一线程。</p>

<p>Version4：</p>

<p>在RedisLock Bean中加入一些额外的信息：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLock</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">threadId</span><span class="o">;</span>  <span class="c1">// 新增线程ID字段</span>
  	<span class="o">.....</span><span class="na">省略其他代码</span><span class="o">.....</span>
      
    
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisDemo</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="c1">//拿锁的EVAL函数</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_LOCK</span> <span class="o">=</span> <span class="s">"return redis.call('SET', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) "</span><span class="o">;</span>

    <span class="c1">// 释放锁的Lua脚本</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_UNLOCK</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('del', KEYS[1]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
            <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="c1">// 获取当前线程ID</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">uuid</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">tryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">tryLockTimeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
                <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_LOCK</span><span class="o">,</span>
                        <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">key</span><span class="o">),</span>
                        <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">))</span>  <span class="c1">// 使用包含线程ID的lockValue</span>
                <span class="o">);</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
                <span class="n">tryCount</span><span class="o">++;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="k">new</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="n">tryCount</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Fail to get lock key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 验证当前线程是否为加锁线程</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Current thread[{}] is not the lock owner[{}], will not unlock"</span><span class="o">,</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_UNLOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">)</span>  <span class="c1">// 使用包含线程ID的lockValue</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to release lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在Version4版本中，我们中RedisLock中加入了ThreadId字段，表示当前获取锁的线程ID，在加锁和解锁时，分别加入当前线程的ID标识，保证解锁的线程必须和加锁的线程一致。</p>

<p>至此，我们基本上完成了Redis分布式锁的实现，最后的Version4已经是一个生产环境可用的版本，足以应对绝对大部分的业务场景使用。</p>

<h3 id="think-more">Think More</h3>

<p>But，我们是追求完美主义的程序员（Doge），Version4已经足够可用，但是再想想，可否继续优化呢？</p>

<p>设想一个场景，加入线程A获取到锁资源，将锁的过期时间设定为3秒，然后线程A就去执行业务逻辑代码了，但是业务代码中，存在一个调用外部API的方法，这个方法出了点意外，耗时超过了3秒，此时锁已经过期，但是业务逻辑并没有执行完毕，此时等待抢锁的线程B，正好就拿到了锁，执行相同的业务代码，这显然不是我们所期望的，那么该如何解决？</p>

<p>如果使用过Redisson的童鞋想必已经猜到了，我们需要一个锁（Lock）的看门狗（Watch Dog），来检查锁是否需要进行续期操作。</p>

<p>Version5：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisLockUtil</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="c1">// 锁的过期时间，单位毫秒</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">DEFAULT_LOCK_TIMEOUT</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span>

    <span class="c1">// 争抢锁的超时时间，单位毫秒，0代表永不超时（一直抢到锁为止）</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">DEFAULT_TRY_LOCK_TIMEOUT</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="c1">//拿锁的EVAL函数</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_LOCK</span> <span class="o">=</span> <span class="s">"return redis.call('SET', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) "</span><span class="o">;</span>

    <span class="c1">// 释放锁的Lua脚本</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_UNLOCK</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('del', KEYS[1]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="c1">// 添加续期相关的常量</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_RENEW</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('pexpire', KEYS[1], ARGV[2]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="c1">// 续期时间点（锁过期时间的2/3处开始续期）</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">RENEW_FACTOR</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="mi">3</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">lock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="no">DEFAULT_LOCK_TIMEOUT</span><span class="o">,</span> <span class="no">DEFAULT_TRY_LOCK_TIMEOUT</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">lockAndExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">lockAndExecute</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="no">DEFAULT_LOCK_TIMEOUT</span><span class="o">,</span> <span class="no">DEFAULT_TRY_LOCK_TIMEOUT</span><span class="o">,</span> <span class="n">supplier</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockAndExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">lockAndExecute</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="no">DEFAULT_LOCK_TIMEOUT</span><span class="o">,</span> <span class="no">DEFAULT_TRY_LOCK_TIMEOUT</span><span class="o">,</span> <span class="n">runnable</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 获取分布式锁
     *
     * @param key   redis key名称
     * @param lockTimeout   锁时长
     * @param tryLockTimeout   尝试获取锁等待时间
     * @return
     */</span>
    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
            <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">uuid</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">tryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="k">while</span> <span class="o">(</span><span class="n">tryLockTimeout</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">timestamp</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">tryLockTimeout</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
                <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_LOCK</span><span class="o">,</span>
                        <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">key</span><span class="o">),</span>
                        <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">))</span>
                <span class="o">);</span>
                <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
                <span class="n">tryCount</span><span class="o">++;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()))</span> <span class="o">{</span>
                    <span class="nc">RedisLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> 
                            <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="n">tryCount</span><span class="o">);</span>
                    <span class="c1">// 启动续期守护线程</span>
                    <span class="n">startRenewThread</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
                    <span class="k">return</span> <span class="n">lock</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Fail to get lock key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 启动续期守护线程
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startRenewThread</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">renewThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">renewInterval</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getLockTimeout</span><span class="o">()</span> <span class="o">*</span> <span class="no">RENEW_FACTOR</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">renewInterval</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">renewed</span> <span class="o">=</span> <span class="n">renewLock</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">renewed</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">renewThread</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">renewThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">setRenewThread</span><span class="o">(</span><span class="n">renewThread</span><span class="o">);</span>  <span class="c1">// 需要在RedisLock类中添加renewThread字段</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 续期锁
     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">renewLock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_RENEW</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getLockTimeout</span><span class="o">()))</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Successfully renewed lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Failed to renew lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error while renewing lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 加锁执行业务逻辑，执行完成后自动释放锁
     *
     * @param key      锁的key
     * @param supplier 需要执行的业务逻辑
     * @param &lt;T&gt;      返回值类型
     * @return 业务逻辑的执行结果
     */</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">lockAndExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">,</span> <span class="nc">Supplier</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">supplier</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RedisLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">tryLockTimeout</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">lock</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">supplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"获取锁失败: "</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">lock</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">unlock</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 加锁执行无返回值的业务逻辑，执行完成后自动释放锁
     *
     * @param key      锁的key
     * @param runnable 需要执行的业务逻辑
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">lockAndExecute</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">,</span> <span class="nc">Runnable</span> <span class="n">runnable</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RedisLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">tryLockTimeout</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">lock</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"获取锁失败: "</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Objects</span><span class="o">.</span><span class="na">nonNull</span><span class="o">(</span><span class="n">lock</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">unlock</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="c1">// 验证当前线程是否为加锁线程</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Current thread[{}] is not the lock owner[{}], will not unlock"</span><span class="o">,</span> 
                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 停止续期线程</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getRenewThread</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">getRenewThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_UNLOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">)</span>  <span class="c1">// 使用包含线程ID的lockValue</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to release lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在这个版本中，我们加入了看门狗的锁续期逻辑，在锁的过期时间达到我们指定的阈值时，会触发锁续期的线程，执行锁续期逻辑，同时我们还加入了一些门面方法，将RedisLockUtil更加易用，就此，我们基本完成了一个非常优秀的分布式锁实现。</p>

<h3 id="something-else">Something Else…</h3>

<p>关于RedisLock的完整实现基本完成，如果了解过Java的ReentrantLock的同学应该知道，concurrent package中的锁的实现，基本都是基于AQS队列实现的，如果您对AQS不太了解，可以点击这里：</p>

<p><a href="https://blog.csdn.net/wtopps/article/details/82054186">聊聊并发：（七）concurrent包之AbstractQueuedSynchronizer分析 </a></p>

<p>那么我们的RedisLock是否也可以与AQS结合呢？这是个有意思的问题，我们来一起尝试一下：</p>

<p>Version6：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLock</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">threadId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">tryCount</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Thread</span> <span class="n">renewThread</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RedisLockUtil</span><span class="o">.</span><span class="na">Sync</span> <span class="n">sync</span><span class="o">;</span>  <span class="c1">// 添加sync字段</span>

    <span class="kd">public</span> <span class="nf">RedisLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="no">UUID</span> <span class="n">uuid</span><span class="o">,</span> <span class="kt">long</span> <span class="n">threadId</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">startLockTimeMillis</span><span class="o">,</span> <span class="kt">long</span> <span class="n">getLockTimeMillis</span><span class="o">,</span> <span class="kt">int</span> <span class="n">tryCount</span><span class="o">,</span> <span class="nc">RedisLockUtil</span><span class="o">.</span><span class="na">Sync</span> <span class="n">sync</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">uuid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">threadId</span> <span class="o">=</span> <span class="n">threadId</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">startLockTimeMillis</span> <span class="o">=</span> <span class="n">startLockTimeMillis</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">getLockTimeMillis</span> <span class="o">=</span> <span class="n">getLockTimeMillis</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tryCount</span> <span class="o">=</span> <span class="n">tryCount</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sync</span> <span class="o">=</span> <span class="n">sync</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">.....</span><span class="na">省略部分代码</span><span class="o">.....</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisLockUtil</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">RedisLockUtil</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JedisClient</span> <span class="n">jedisClient</span><span class="o">;</span>

    <span class="c1">//拿锁的EVAL函数</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_LOCK</span> <span class="o">=</span> <span class="s">"return redis.call('SET', KEYS[1], ARGV[1], 'NX', 'PX', ARGV[2]) "</span><span class="o">;</span>

    <span class="c1">// 释放锁的Lua脚本</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_UNLOCK</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('del', KEYS[1]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="c1">// 添加续期相关的常量</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">LUA_SCRIPT_RENEW</span> <span class="o">=</span>
            <span class="s">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> <span class="o">+</span>
                    <span class="s">"    redis.call('pexpire', KEYS[1], ARGV[2]); "</span> <span class="o">+</span>
                    <span class="s">"    return 'suc' "</span> <span class="o">+</span>
                    <span class="s">"else "</span> <span class="o">+</span>
                    <span class="s">"    return 'fail' "</span> <span class="o">+</span>
                    <span class="s">"end"</span><span class="o">;</span>

    <span class="c1">// 续期时间点（锁过期时间的2/3处开始续期）</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">double</span> <span class="no">RENEW_FACTOR</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">/</span><span class="mi">3</span><span class="o">;</span>


    <span class="cm">/**
     * 基于AQS的同步器实现
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Sync</span> <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Redis1</span> <span class="n">lockUtil</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">key</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">;</span>
        <span class="kd">private</span> <span class="nc">RedisLock</span> <span class="n">redisLock</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Sync</span><span class="o">(</span><span class="nc">Redis1</span> <span class="n">lockUtil</span><span class="o">,</span> <span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lockUtil</span> <span class="o">=</span> <span class="n">lockUtil</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">;</span>
            <span class="k">this</span><span class="o">.</span><span class="na">lockTimeout</span> <span class="o">=</span> <span class="n">lockTimeout</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 尝试获取Redis锁</span>
            <span class="n">redisLock</span> <span class="o">=</span> <span class="n">lockUtil</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">redisLock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">redisLock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">lockUtil</span><span class="o">.</span><span class="na">unlock</span><span class="o">(</span><span class="n">redisLock</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">getRedisLock</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">redisLock</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 尝试获取锁的内部方法，不包含AQS逻辑
     */</span>
    <span class="kd">private</span> <span class="nc">RedisLock</span> <span class="nf">tryLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="nc">Sync</span> <span class="n">sync</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 将原来lock方法的实现移到这里</span>
        <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s">".lock"</span><span class="o">;</span>
            <span class="no">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">uuid</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">();</span>

            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_LOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">key</span><span class="o">),</span>
                    <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lockTimeout</span><span class="o">))</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="s">"OK"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nc">RedisLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisLock</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">uuid</span><span class="o">,</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span>
                        <span class="n">lockTimeout</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">(),</span> <span class="mi">1</span><span class="o">,</span> <span class="n">sync</span><span class="o">);</span>
                <span class="n">startRenewThread</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">lock</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Fail to get lock key: {}"</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 获取分布式锁（使用AQS实现线程排队）
     */</span>
    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">lock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sync</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">);</span>
        <span class="n">sync</span><span class="o">.</span><span class="na">acquire</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// 阻塞直到获取到锁</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">getRedisLock</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 尝试获取分布式锁（非阻塞）
     */</span>
    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">tryLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sync</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquire</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">?</span> <span class="n">sync</span><span class="o">.</span><span class="na">getRedisLock</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 带超时的尝试获取分布式锁
     */</span>
    <span class="kd">public</span> <span class="nc">RedisLock</span> <span class="nf">tryLock</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">lockTimeout</span><span class="o">,</span> <span class="kt">long</span> <span class="n">tryLockTimeout</span><span class="o">,</span> <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Sync</span> <span class="n">sync</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Sync</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">key</span><span class="o">,</span> <span class="n">lockTimeout</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">sync</span><span class="o">.</span><span class="na">tryAcquireNanos</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">tryLockTimeout</span><span class="o">))</span> <span class="o">?</span> <span class="n">sync</span><span class="o">.</span><span class="na">getRedisLock</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="cm">/**
     * 启动续期守护线程
     */</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">startRenewThread</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">renewThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">renewInterval</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getLockTimeout</span><span class="o">()</span> <span class="o">*</span> <span class="no">RENEW_FACTOR</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">renewInterval</span><span class="o">);</span>
                    <span class="kt">boolean</span> <span class="n">renewed</span> <span class="o">=</span> <span class="n">renewLock</span><span class="o">(</span><span class="n">lock</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">renewed</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">renewThread</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">renewThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">setRenewThread</span><span class="o">(</span><span class="n">renewThread</span><span class="o">);</span>  <span class="c1">// 需要在RedisLock类中添加renewThread字段</span>
    <span class="o">}</span>

    <span class="cm">/**
     * 续期锁
     */</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">renewLock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_RENEW</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getLockTimeout</span><span class="o">()))</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"Successfully renewed lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Failed to renew lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Error while renewing lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">unlock</span><span class="o">(</span><span class="nc">RedisLock</span> <span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// 验证当前线程是否为加锁线程</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">()</span> <span class="o">!=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"Current thread[{}] is not the lock owner[{}], will not unlock"</span><span class="o">,</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">(),</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">());</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 停止续期线程</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getRenewThread</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">getRenewThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="nc">String</span> <span class="n">lockValue</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">getUuid</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">lock</span><span class="o">.</span><span class="na">getThreadId</span><span class="o">();</span>
            <span class="nc">JedisClusterPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">jedisClient</span><span class="o">.</span><span class="na">getPipelined</span><span class="o">();</span>
            <span class="nc">Response</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">eval</span><span class="o">(</span><span class="no">LUA_SCRIPT_UNLOCK</span><span class="o">,</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">()),</span>
                    <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="n">lockValue</span><span class="o">)</span>  <span class="c1">// 使用包含线程ID的lockValue</span>
            <span class="o">);</span>
            <span class="n">pipeline</span><span class="o">.</span><span class="na">sync</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">response</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nc">Objects</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="s">"suc"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Failed to release lock: {}"</span><span class="o">,</span> <span class="n">lock</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">e</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="结语">结语</h2>

<p>本篇，我们从0-1，从简单到复杂完整了实现了一个Redis分布式锁，实现的细节难免粗糙，如果有问题请您指出，希望本篇可以给您提供一个思路，谢谢。</p>

